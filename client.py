import os
try:
  import boto3
except:
  os.system('pip install boto3')
import numpy as np
import argparse
import ast
from sklearn.preprocessing import RobustScaler

def main():
 
    import json
    try:
      import ember
    except:
      os.system('wget https://github.com/endgameinc/ember/archive/master.zip')
      os.system('unzip master.zip')
      os.system('rm master.zip')
      os.system('cp -r ember-master/* .')
      os.system('rm -r ember-master')
      os.system('pip install -r requirements.txt')
      os.system('python setup.py install')
      import ember

    from sklearn.preprocessing import RobustScaler
    rs = RobustScaler()
       
    parser = argparse.ArgumentParser()
    parser.add_argument("-v", "--featureversion", type=int, default=2, help="EMBER feature version")
    parser.add_argument("binaries", metavar="BINARIES", type=str, nargs="+", help="PE files to classify")
    args = parser.parse_args()

    testpe = open(args.binaries[0],'rb').read()

    extract = ember.PEFeatureExtractor() 
    print("Test1")
    try:
      data = extract.feature_vector(testpe)
    except Exception as inst:
      print(inst)
    print("Test2")
    scaled_data = rs.fit_transform([data])
    Xdata = np.reshape(scaled_data,(1, 2381))
    Xdata= Xdata.tolist()
    print("Test3")
    client = boto3.client('runtime.sagemaker',
				region_name='us-east-1',
				aws_access_key_id='XXXXXXXX', 
				aws_secret_access_key='XXXXXXXXXXX',
				aws_session_token='XXXXXXXXXXXXXX')
    print("Test4")
    response = client.invoke_endpoint(EndpointName='sagemaker-tensorflow-serving-2021-10-13-02-12-37-244', Content="application/json" Body=json.dumps(Xdata))
    response_body = response['Body']
    out = response_body.read()
    print(out)
		
if __name__ == "__main__":
	main()